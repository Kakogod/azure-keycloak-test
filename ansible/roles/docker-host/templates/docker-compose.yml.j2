version: "3.8"
services:
  keycloak:
    image: quay.io/keycloak/keycloak:22.0.5
    container_name: keycloak
    command: start-dev --http-enabled=true --hostname-strict=false --hostname-strict-https=false
    restart: unless-stopped
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin123
      KC_HTTP_RELATIVE_PATH: "/auth"
      KC_HTTP_ENABLED: "true"
      KC_PROXY: edge
      KC_HTTPS_REQUIRED: "none"
      JAVA_OPTS: "-Xms128m -Xmx256m"
      KC_DB: postgres
      KC_DB_URL_HOST: postgres
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: examplepassword
    ports:
      - "8080:8080"
    networks:
      - keycloak-net
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  postgres:
    image: postgres:15-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: examplepassword
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - keycloak-net
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  nginx:
    image: nginx:stable
    container_name: nginx
    restart: unless-stopped
    volumes:
      - ./nginx/site:/usr/share/nginx/html:ro
    ports:
      - "80:80"
    networks:
      - keycloak-net
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.2.0
    container_name: oauth2-proxy
    ports:
      - "4180:4180"
    environment:
      OAUTH2_PROXY_PROVIDER: keycloak
      OAUTH2_PROXY_CLIENT_ID: oauth2-proxy
      OAUTH2_PROXY_CLIENT_SECRET: "EzWkzsm53s8uVov9CdE8eGOFqV04emhf"
      OAUTH2_PROXY_COOKIE_SECRET: "TCLAtDN5wQmvV03pdukGNlTFl0kKDa6aj01uQjJl6IU="
      OAUTH2_PROXY_COOKIE_SECURE: "false"
      OAUTH2_PROXY_COOKIE_HTTP_ONLY: "true"
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_ALLOW_UPSTREAM_LOGINS: "true"
      OAUTH2_PROXY_UPSTREAMS: "http://nginx:80"
      OAUTH2_PROXY_REDIRECT_URL: "http://20.16.65.81:4180/oauth2/callback"
      OAUTH2_PROXY_LOGIN_URL: "http://20.16.65.81:8080/auth/realms/myrealm/protocol/openid-connect/auth"
      OAUTH2_PROXY_REDEEM_URL: "http://20.16.65.81:8080/auth/realms/myrealm/protocol/openid-connect/token"
      OAUTH2_PROXY_VALIDATE_URL: "http://20.16.65.81:8080/auth/realms/myrealm/protocol/openid-connect/userinfo"
    networks:
      - keycloak-net

networks:
  keycloak-net:
    driver: bridge

volumes:
  pgdata:

